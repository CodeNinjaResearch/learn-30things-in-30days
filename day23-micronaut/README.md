# Day 23: Micronaut - A Java based full-stack microservices framework

## What is Micronaut

[Micronaut](http://micronaut.io/) - A modern, JVM-based, full-stack framework for building modular, easily testable microservice and serverless applications.

Micronaut is developed by the creators of the Grails framework and takes inspiration from lessons learnt over the years building real-world applications from monoliths to microservices using Spring, Spring Boot and Grails.

#### Like Spring, but faster

Micronaut’s main advantage is its speed. A server written in Java requires less than one second to start, with a minimal JAR size of 8 MB. That’s fairly impressive.

How small is Micronaut? This small:

- JAR files
  - 8MB in Java
  - 12 MB in Groovy
  - Spring and Groovy – 36MB
  - Grails – 27 MB
- Heap size
  - 7MB in Java
  - 19 MB in Groovy
  - Spring and Groovy – 33 MB
  - Grails – 49 MB
- Startup time
  - Java ~1 second
  - Spring / Grails ~3-4 seconds

## Build a sample application with Micronaut on Windows

#### Install through Binary on Windows

- Download the latest binary from [Micronaut Website](http://micronaut.io/download.html)
- Extract the binary to appropriate location (For example: C:\development\micronaut)
- Create an environment variable MICRONAUT_HOME which points to the installation directory i.e. C:\development\micronaut
- Update the PATH environment variable, append %MICRONAUT_HOME%\bin.

Now I'm able to run the Micronaut CLI from the command prompt as follows:

```
C:\>mn
Resolving dependencies...
| Starting interactive mode...
| Enter a command name to run. Use TAB for completion:
mn>
```
 
#### Create a RESTful server Application

execute following command in Micronaut CLI
>mn create-app io.examples.micronaut.petstore -f spock -b maven

The Micronaut CLI generate the java project
```
mn> mn create-app io.examples.micronaut.petstore -f spock -b maven
| Generating Java project...
| Application created at E:\Workspaces\learn-30things-in-30days\day23-micronaut\petstore
| Initializing application. Please wait...
mn>
```

**Build Application**
```
cd petstore
mvn clean install
```

**Run application**
```
java -jar target\petstore-0.1.jar
21:41:45.453 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 3154ms. Server Running: http://localhost:8080
```

The server is start at port 8080, open http://localhost:8080 in browser, it display below json
```json
{
    "_links": {
        "self": {
            "href": "/",
            "templated": false
        }
    },
    "message": "Page Not Found"
}
```

Below is the project structure generated by create-app command

<img width="460" src="https://user-images.githubusercontent.com/3359299/47401403-36487680-d70f-11e8-8710-7b9b1be8efa6.PNG" />

**Application.java**
```java
package io.examples.micronaut;

import io.micronaut.runtime.Micronaut;

public class Application {

    public static void main(String[] args) {
        Micronaut.run(Application.class);
    }
}
```

**Application.yml**
```yaml
micronaut:
    application:
        name: petstore
```

**Add controller**

create Health.java

```java
public class Health {
    private String version;
    private String status;

    public Health() {
    }

    public Health(String version, String status) {
        this.version = version;
        this.status = status;
    }

    public String getVersion() {
        return version;
    }

    public void setVersion(String version) {
        this.version = version;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }
}
```

Add PetController.java

```java
@Controller("/v1/pet")
public class PetController {
    @Get
    public HttpStatus index() {
        return HttpStatus.OK;
    }

    @Get("/version")
    public Health version() {
        return new Health("1.0", "OK");
    }
}
```

Restart application, and open http://localhost:8080/v1/pet/version, it displays following json in broswer.

```json
{
    "version": "1.0",
    "status": "OK"
}
```

Modify application.yml to change server port to 9080

```yaml
micronaut:
  server:
    port: 9080
  application:
    name: petstore
```

To simplify the sample, I copied entity, repository and common package which I already have coded in previous days, but since this annotation processor can't process lombok with Micornaut in compiler plugin, I have to remove all lombok annotations.

Now let's modify petController to implement following resources

|Method|Url|Description|
|:---|:---|:---|
|GET|/v1/pet|Get all pets|
|GET|/v1/pet/{id}|Find pet by id|
|GET|/v1/pet/findByCategory/{category}|Find pets by category|
|POST|/v1/pet|Add a new pet|
|PUT|/v1/pet/{id}|Update a pet|
|Delete|/v1/pet/{id}|Delete a pet|

**PetController.java**

```java
package io.examples.micronaut.controller;

import io.examples.micronaut.common.ApiResponse;
import io.examples.micronaut.common.ApiResponses;
import io.examples.micronaut.entity.Product;
import io.examples.micronaut.health.Health;
import io.examples.micronaut.repository.ProductRepository;
import io.micronaut.http.annotation.Body;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Delete;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.http.annotation.Put;
import io.reactivex.Single;

import javax.inject.Inject;
import java.util.List;
import java.util.Optional;

/**
 * @author Gary Cheng
 */
@Controller("/v1/pet")
public class PetController {
    @Inject
    private ProductRepository productRepository;

    @Get("/version")
    public Health version() {
        return new Health("1.0", "OK");
    }

    @Get
    public Single<List<Product>> all() {
        return Single.create(emitter -> emitter.onSuccess(productRepository.getProducts()));
    }

    @Get("/{id}")
    public Single<?> byId(Integer id) {
        return Single.create(emitter -> {
            Optional<Product> product = productRepository.getProductById(id);
            if (product.isPresent()) {
                emitter.onSuccess(product.get());
            } else {
                emitter.onSuccess(ApiResponses.ERR_PET_NOT_FOUND);
            }
        });
    }

    @Get("/findByCategory/{category}")
    public Single<List<Product>> byCategory(String category) {
        return Single.create(emitter -> emitter.onSuccess(productRepository.getProductsByCategory(category)));
    }

    @Post()
    public Single<Product> add(@Body Product product) {
        return Single.create(emitter -> {
            Product newProduct = productRepository.addProduct(product);
            emitter.onSuccess(newProduct);
        });
    }

    @Put("/{id}")
    public Single<ApiResponse> update(Integer id, @Body Product product) {
        return Single.create(emitter -> {
            ApiResponse response = productRepository.getProductById(id)
                    .map(p -> {
                        product.setId(p.getId());
                        productRepository.updateProduct(product);
                        return ApiResponses.MSG_UPDATE_SUCCESS;
                    }).orElse(ApiResponses.ERR_PET_NOT_FOUND);
            emitter.onSuccess(response);
        });
    }

    @Delete("/{id}")
    public Single<ApiResponse> delete(Integer id) {
        return Single.create(emitter -> {
            ApiResponse response = productRepository.getProductById(id)
                    .map(p -> {
                        productRepository.deleteProduct(id);
                        return ApiResponses.MSG_DELETE_SUCCESS;
                    })
                    .orElse(ApiResponses.ERR_PET_NOT_FOUND);
            emitter.onSuccess(response);
        });
    }
}
```

That's all for today, you can find the complete source code under [this folder](petstore).